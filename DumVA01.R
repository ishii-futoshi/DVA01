################################################################################
# DumVA01.R
# Dummy Variable Adjustment
# DMA研究会
################################################################################
rm(list = ls())

################################################################################
# Reset Graphics
################################################################################
old.par <- par(no.readonly = TRUE)

################################################################################
# Load Libraries
################################################################################

################################################################################
# Load Functions
################################################################################

################################################################################
# Define Functions
################################################################################

################################################################################
# Set Parameters
################################################################################

################################################################################
# ケース1
################################################################################
c_j <- c(0, 1, 2)
I1 <- c(1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
I2 <- c(0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0)
I3 <- c(0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0)
Im <- c(0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1)
n_j <- c(sum(I1), sum(I2), sum(I3), sum(Im))
n <- sum(n_j)
I_ji <- matrix(c(I1, I2, I3, Im), nrow = n)

X1 <- c(20, 30, 10, 40, 10, 20, 10, 40, 30, 10, 40, 40)
X2 <- as.vector(I_ji[, -dim(I_ji)[2]] %*% c_j)
X2[Im == 1] <- c_j[c(2, 3, 2, 1, 3, 1)]

#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=
# 連続型
#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=
X <- matrix(c(rep(1, n), X1, X2), nrow = n)
Y0 <- matrix(0, nrow = n, ncol = 1)
Y0 <- X %*% c(5, 0.5, -0.2)

Y <- Y0
(beta <- solve(t(X) %*% X) %*% t(X) %*% Y)

XI1 <- matrix(c(1 - Im, X1, X2 * (1 - Im), Im), nrow = n)
(theta1 <- solve(t(XI1) %*% XI1) %*% t(XI1) %*% Y)

XI2 <- matrix(c(1 - Im, X1 * (1 - Im), X2 * (1 - Im), Im, X1 * Im), nrow = n)
(theta2 <- solve(t(XI2) %*% XI2) %*% t(XI2) %*% Y)

Pm <- n_j[length(n_j)] / n
X1b_c <- sum(X1[Im == 0]) / (n - n_j[4])
X2b_c <- sum(X2[Im == 0]) / (n - n_j[4])
X1b_m <- sum(X1[Im == 1]) / n_j[4]
X2b_m <- sum(X2[Im == 1]) / n_j[4]
S11_c <- sum((X1[Im == 0] - X1b_c) ^ 2) / (n - n_j[4])
S22_c <- sum((X2[Im == 0] - X2b_c) ^ 2) / (n - n_j[4])
S12_c <- sum((X1[Im == 0] - X1b_c) * (X2[Im == 0] - X2b_c)) / (n - n_j[4])
S11_m <- sum((X1[Im == 1] - X1b_m) ^ 2) / n_j[4]
S12_m <- sum((X1[Im == 1] - X1b_m) * (X2[Im == 1] - X2b_m)) / n_j[4]
D <- (1 - n_j[4] / n) * S11_m * S22_c + n_j[4] / n * (S11_c * S22_c - S12_c ^ 2)
F0 <- (S12_c * X2b_c - S22_c * X1b_c) / D
F1 <- S22_c / D
F2 <- S12_c / D

# Th 3.1
(theta1_hat <- c(beta[1] + beta[3] * Pm * S12_m * F0,
                 beta[2] + beta[3] * Pm * S12_m * F1,
                 beta[3] - beta[3] * Pm * S12_m * F2))

# Th 3.2
(theta2_hat <- c(beta[1],
                 beta[2],
                 beta[3],
                 beta[1] + beta[3] * (X2b_m - X1b_m * S12_m / S11_m),
                 beta[2] + beta[3] * S12_m / S11_m))

#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=
# 離散型
#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=
XI_s1 <- matrix(c(X1, I1, I2, I3, Im), nrow = n)
(gamma1 <- solve(t(XI_s1) %*% XI_s1) %*% t(XI_s1) %*% Y)

XI_s2 <- matrix(c(X1 * (1 - Im), I1, I2, I3, X1 * Im, Im), nrow = n)
(gamma2 <- solve(t(XI_s2) %*% XI_s2) %*% t(XI_s2) %*% Y)

X1b_j <- colSums(X1 %o% rep(1, dim(I_ji)[2]) * I_ji) / n_j
X2b_j <- colSums(X2 %o% rep(1, dim(I_ji)[2]) * I_ji) / n_j
S11_o <- (sum((X1[I1 == 1] - X1b_j[1]) ^ 2) + 
              sum((X1[I2 == 1] - X1b_j[2]) ^ 2) + 
              sum((X1[I3 == 1] - X1b_j[3]) ^ 2) +
              sum((X1[Im == 1] - X1b_j[4]) ^ 2)
          ) / n

# Th 4.1
(gamma1_hat <- c(beta[2] + Pm * S12_m / S11_o * beta[3],
                beta[1] + (c_j[1] - X1b_j[1] * Pm * S12_m / S11_o) * beta[3],
                beta[1] + (c_j[2] - X1b_j[2] * Pm * S12_m / S11_o) * beta[3],
                beta[1] + (c_j[3] - X1b_j[3] * Pm * S12_m / S11_o) * beta[3],
                beta[1] + (X2b_j[4] - X1b_j[4] * Pm * S12_m / S11_o) * beta[3]))

(gamma2_hat <- c(beta[2], 
                beta[1] + c_j[1] * beta[3], 
                beta[1] + c_j[2] * beta[3], 
                beta[1] + c_j[3] * beta[3],
                beta[2] + S12_m / S11_m * beta[3],
                beta[1] + (X2b_j[4] - X1b_j[4] * S12_m / S11_m) * beta[3]))


################################################################################
# ケース2
################################################################################
c_j <- c(0, 1, 2)
I1 <- c(1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
I2 <- c(0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0)
I3 <- c(0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0)
Im <- c(0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1)
n_j <- c(sum(I1), sum(I2), sum(I3), sum(Im))
n <- sum(n_j)
I_ji <- matrix(c(I1, I2, I3, Im), nrow = n)

X1 <- c(20, 30, 10, 40, 10, 20, 10, 40, 30, 10, 40, 40)
X2 <- as.vector(I_ji[, -dim(I_ji)[2]] %*% c_j)
X2[Im == 1] <- 1

#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=
# 連続型
#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=
X <- matrix(c(rep(1, n), X1, X2), nrow = n)
Y0 <- matrix(0, nrow = n, ncol = 1)

beta_s1 <- c( 5, 0.5, -0.2)
beta_s2 <- c(10, 0.7)

Y0[seq(n - n_j[length(n_j)]),] <- X[seq(n - n_j[length(n_j)]),] %*% beta_s1
Y0[-seq(n - n_j[length(n_j)]),] <- X[-seq(n - n_j[length(n_j)]), seq(2)] %*% beta_s2

Y <- Y0

XI2 <- matrix(c(1 - Im, X1 * (1 - Im), X2 * (1 - Im), Im, X1 * Im), nrow = n)
(theta2 <- solve(t(XI2) %*% XI2) %*% t(XI2) %*% Y)

#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=
# 離散型
#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=
XI_s2 <- matrix(c(X1 * (1 - Im), I1, I2, I3, X1 * Im, Im), nrow = n)
(gamma2 <- solve(t(XI_s2) %*% XI_s2) %*% t(XI_s2) %*% Y)



